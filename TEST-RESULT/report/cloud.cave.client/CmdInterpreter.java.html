<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CmdInterpreter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage of SkyCave</a> &gt; <a href="index.source.html" class="el_package">cloud.cave.client</a> &gt; <span class="el_source">CmdInterpreter.java</span></div><h1>CmdInterpreter.java</h1><pre class="source lang-java linenums">package cloud.cave.client;

import java.io.*;

import org.json.simple.JSONObject;

import cloud.cave.common.PlayerSessionExpiredException;
import cloud.cave.domain.*;

/**
 * The client interpreter, implementing a classic shell based read-eval-loop
 * command line tool to log a player into the cave and allow him/her to explore
 * it.
 * 
 * @author Henrik Baerbak Christensen, Aarhus University
 * 
 */
public class CmdInterpreter {

  private Cave cave;
  private Player player;
  
  private PrintStream systemOut;
  private InputStream systemIn;

  /**
   * Construct the interpreter.
   * 
   * @param cave
   *          the cave to log into
   * @param loginName
   *          the loginName of the player
   * @param pwd
   *          the password of the player
   * @param systemOut
   *          the print stream that acts as shell output
   * @param systemIn
   *          the input stream that act as keyboard input
   */
<span class="fc" id="L40">  public CmdInterpreter(Cave cave, String loginName, String pwd, PrintStream systemOut, InputStream systemIn) {</span>
<span class="fc" id="L41">    this.cave = cave;</span>

<span class="fc" id="L43">    this.systemOut = systemOut;</span>
<span class="fc" id="L44">    this.systemIn = systemIn;</span>
    
<span class="fc" id="L46">    Login loginResult = null;</span>

<span class="fc" id="L48">    systemOut.println(&quot;Trying to log in player with loginName: &quot; + loginName);</span>

<span class="fc" id="L50">    loginResult = cave.login(loginName, pwd);</span>

<span class="fc" id="L52">    boolean success = LoginResult.isValidLogin(loginResult.getResultCode());</span>

<span class="pc bpc" id="L54" title="2 of 4 branches missed.">    if (!success) {</span>
<span class="nc" id="L55">      systemOut.println(&quot;*** SORRY! The login failed. Reason: &quot;</span>
<span class="nc" id="L56">          + loginResult.getResultCode());</span>
<span class="nc" id="L57">      System.exit(-1);</span>
    }
<span class="fc bfc" id="L59" title="All 4 branches covered.">    if (loginResult.getResultCode() == LoginResult.LOGIN_SUCCESS_PLAYER_ALREADY_LOGGED_IN) {</span>
<span class="fc" id="L60">      systemOut.println(&quot;*** WARNING! User '&quot;</span>
<span class="fc" id="L61">          + loginResult.getPlayer().getName() + &quot;' is ALREADY logged in! ***&quot;);</span>
<span class="fc" id="L62">      systemOut</span>
<span class="fc" id="L63">          .println(&quot;*** The previous session will be disconnected. ***&quot;);</span>
    }
<span class="fc" id="L65">    player = loginResult.getPlayer();</span>
<span class="fc" id="L66">  }</span>

  /**
   * The classic 'read command, evaluate command, loop' of a shell. Issue your
   * command, and see the result in the shell.
   */
  public void readEvalLoop() {
<span class="fc" id="L73">    systemOut.println(&quot;== Welcome to SkyCave, player &quot; + player.getName()</span>
        + &quot; ==&quot;);

<span class="fc" id="L76">    systemOut.println(cave.describeConfiguration());</span>
    
<span class="fc" id="L78">    systemOut.println(&quot;Type 'h' for help!&quot;);</span>

<span class="fc" id="L80">    BufferedReader bf = new BufferedReader(new InputStreamReader(systemIn));</span>

<span class="fc" id="L82">    systemOut</span>
<span class="fc" id="L83">        .println(&quot;Entering command loop, type \&quot;q\&quot; to quit, \&quot;h\&quot; for help.&quot;);</span>

    // and enter the command processing loop
    String line;
    try {
      do {
<span class="fc" id="L89">        line = bf.readLine();</span>
<span class="pc bpc" id="L90" title="2 of 4 branches missed.">        if (line.length() &gt; 0) {</span>
          // split into into tokes on whitespace
<span class="fc" id="L92">          String[] tokens = line.split(&quot;\\s&quot;);</span>

          // First handle the 'short hand' notation for movement
<span class="fc bfc" id="L95" title="All 4 branches covered.">          if (tokens[0].length() == 1) {</span>
<span class="fc" id="L96">            char primaryCommand = line.charAt(0);</span>

<span class="fc" id="L98">            handleSingleCharCommand(primaryCommand);</span>

<span class="fc" id="L100">          } else {</span>
<span class="fc" id="L101">            handleMultipleCharCommand(tokens[0], tokens);</span>
          }
<span class="fc" id="L103">          systemOut.println();</span>
        }
<span class="fc bfc" id="L105" title="All 4 branches covered.">      } while (!line.equals(&quot;q&quot;));</span>
<span class="nc" id="L106">    } catch (PlayerSessionExpiredException exc) {</span>
<span class="nc" id="L107">      systemOut</span>
<span class="nc" id="L108">          .println(&quot;**** Sorry! Another session has started with the same loginID. ***&quot;);</span>
<span class="nc" id="L109">      systemOut</span>
<span class="nc" id="L110">          .println(&quot;**** You have been logged out.                                 ***&quot;);</span>
<span class="nc" id="L111">      System.exit(0);</span>
<span class="nc" id="L112">    } catch (IOException e) {</span>
<span class="nc" id="L113">      systemOut.println(&quot;Exception caught: &quot; + e);</span>
<span class="pc" id="L114">    }</span>
<span class="fc" id="L115">    systemOut.println(&quot;Leaving SkyCave - Goodbye.&quot;);</span>
<span class="fc" id="L116">  }</span>

  private void handleMultipleCharCommand(String command, String[] tokens) {
<span class="pc bpc" id="L119" title="2 of 8 branches missed.">    if (command.equals(&quot;dig&quot;) &amp;&amp; tokens.length &gt; 2) {</span>
<span class="fc" id="L120">      Direction direction = getDirectionFromChar(tokens[1].charAt(0));</span>
      // Compile the room description by putting the tokens back into a single string again
<span class="fc" id="L122">      String roomDescription = &quot;&quot;;</span>
<span class="fc" id="L123">      roomDescription = mergeTokens(tokens, 2);</span>
      
<span class="fc" id="L125">      boolean isValid = player.digRoom(direction, roomDescription);</span>
<span class="fc bfc" id="L126" title="All 4 branches covered.">      if (isValid) {</span>
<span class="fc" id="L127">        systemOut.println(&quot;You dug a new room in direction &quot; + direction);</span>
      } else {
<span class="fc" id="L129">        systemOut</span>
<span class="fc" id="L130">            .println(&quot;You cannot dig there as there is already a room in direction &quot;</span>
                + direction);
      }

<span class="fc bfc" id="L134" title="All 4 branches covered.">    } else if (command.equals(&quot;who&quot;)) {</span>
<span class="fc" id="L135">      systemOut.println(&quot;You are: &quot; + player.getName()+ &quot;/&quot;+ player.getID()+ &quot; in Region &quot;+player.getRegion());</span>
<span class="fc" id="L136">      systemOut.println(&quot;   in local session: &quot; + player.getSessionID());</span>

<span class="fc bfc" id="L138" title="All 4 branches covered.">    } else if (command.equals(&quot;weather&quot;)) {</span>
<span class="fc" id="L139">      String weather = player.getWeather();</span>
<span class="fc" id="L140">      systemOut.println(&quot;The weather at: &quot; + player.getRegion());</span>
<span class="fc" id="L141">      systemOut.println(weather);</span>

<span class="pc bpc" id="L143" title="2 of 8 branches missed.">    } else if (command.equals(&quot;post&quot;) &amp;&amp; tokens.length &gt; 1) {</span>
<span class="fc" id="L144">      systemOut.println(&quot;POST awaits implementation&quot;);</span>

<span class="fc bfc" id="L146" title="All 4 branches covered.">    } else if (command.equals(&quot;read&quot;)) {</span>
<span class="fc" id="L147">      systemOut.println(&quot;READ awaits implementation&quot;);</span>

<span class="fc bfc" id="L149" title="All 4 branches covered.">    } else if (command.equals(&quot;sys&quot;)) {</span>
<span class="fc" id="L150">      systemOut.println(&quot;System information:&quot;);</span>
<span class="fc" id="L151">      systemOut.println(cave.describeConfiguration());</span>
<span class="fc" id="L152">      systemOut.println(player.toString());</span>
    
<span class="fc bfc" id="L154" title="All 4 branches covered.">    } else if (command.equals(&quot;exec&quot;)) {</span>
<span class="fc bfc" id="L155" title="All 4 branches covered.">      if (tokens.length &gt; 2) {</span>
<span class="fc" id="L156">        JSONObject response = null;</span>
        // Create the parameter array
<span class="fc" id="L158">        String[] parameters = new String[tokens.length - 2];</span>
<span class="fc bfc" id="L159" title="All 4 branches covered.">        for (int i = 2; i &lt; tokens.length; i++) {</span>
<span class="fc" id="L160">          parameters[i - 2] = tokens[i];</span>
        }

<span class="fc" id="L163">        response = player.execute(tokens[1], parameters);</span>
<span class="fc" id="L164">        systemOut.println(&quot;You executed command:&quot; + tokens[1]);</span>
<span class="fc" id="L165">        systemOut.println(&quot;  Response as JSON: &quot; + response);</span>
<span class="fc" id="L166">      } else {</span>
<span class="fc" id="L167">        systemOut</span>
<span class="fc" id="L168">            .println(&quot;Exec commands require at least one parameter. Set it to null if irrelevant&quot;);</span>
      }
    } else {
<span class="fc" id="L171">      systemOut.println(&quot;I do not understand that long command. (Type 'h' for help)&quot;);</span>
    }
<span class="fc" id="L173">  }</span>

  /**
   * Merge the tokens in array 'tokens' from
   * index 'from' into a space separated string.
   * @param tokens the array of tokens
   * @param from the starting index 
   * @return a merged string with all tokens
   * separated by space
   */
  private String mergeTokens(String[] tokens, int from) {
<span class="fc" id="L184">    String mergedString=&quot;&quot;;</span>
<span class="fc bfc" id="L185" title="All 4 branches covered.">    for (int i=from; i &lt; tokens.length; i++) { mergedString += &quot; &quot;+tokens[i]; }</span>
<span class="fc" id="L186">    return mergedString;</span>
  }

  private void handleSingleCharCommand(char primaryCommand) {
<span class="fc bfc" id="L190" title="All 22 branches covered.">    switch (primaryCommand) {</span>
    // look
    case 'l': {
<span class="fc" id="L193">      systemOut.println(player.getLongRoomDescription());</span>
<span class="fc" id="L194">      break;</span>
    }
    // The movement commands
    case 'n': {
<span class="fc" id="L198">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L199">      break;</span>
    }
    case 's': {
<span class="fc" id="L202">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L203">      break;</span>
    }
    case 'e': {
<span class="fc" id="L206">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L207">      break;</span>
    }
    case 'w': {
<span class="fc" id="L210">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L211">      break;</span>
    }
    case 'u': {
<span class="fc" id="L214">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L215">      break;</span>
    }
    case 'd': {
<span class="fc" id="L218">      tryToMove(getDirectionFromChar(primaryCommand));</span>
<span class="fc" id="L219">      break;</span>
    }

    // position
    case 'p': {
<span class="fc" id="L224">      systemOut.println(&quot;Your position in the cave is: &quot;</span>
<span class="fc" id="L225">          + player.getPosition());</span>
<span class="fc" id="L226">      break;</span>
    }
    // Help
    case 'h': {
<span class="fc" id="L230">      showHelp();</span>
<span class="fc" id="L231">      break;</span>
    }
    // Quit
    case 'q': {
<span class="fc" id="L235">      LogoutResult logoutResult = cave.logout(player.getID());</span>
<span class="fc" id="L236">      systemOut.println(&quot;Logged player out, result = &quot; + logoutResult);</span>
<span class="fc" id="L237">      break;</span>
    }
    default: {
<span class="fc" id="L240">      systemOut.println(&quot;I do not understand that command. (Type 'h' for help)&quot;);</span>
    }
    }
<span class="fc" id="L243">  }</span>

  private Direction getDirectionFromChar(char commandChar) {
<span class="pc bpc" id="L246" title="2 of 14 branches missed.">    switch (commandChar) {</span>
    case 'n':
<span class="fc" id="L248">      return Direction.NORTH;</span>
    case 's':
<span class="fc" id="L250">      return Direction.SOUTH;</span>
    case 'e':
<span class="fc" id="L252">      return Direction.EAST;</span>
    case 'w':
<span class="fc" id="L254">      return Direction.WEST;</span>
    case 'u':
<span class="fc" id="L256">      return Direction.UP;</span>
    case 'd':
<span class="fc" id="L258">      return Direction.DOWN;</span>
    default:
<span class="nc" id="L260">      throw new RuntimeException(&quot;getDirectionFromChar got wrong parameter: &quot;</span>
          + commandChar);
    }
  }

  private void tryToMove(Direction direction) {
<span class="fc bfc" id="L266" title="All 4 branches covered.">    if ( player.move(direction) ) {</span>
<span class="fc" id="L267">      systemOut.println(&quot;You moved &quot;+direction);</span>
<span class="fc" id="L268">      systemOut.println(player.getShortRoomDescription());</span>
    } else {
<span class="fc" id="L270">      systemOut.println(&quot;There is no exit going &quot; + direction);</span>
    }
<span class="fc" id="L272">  }</span>

  private void showHelp() {
<span class="fc" id="L275">    systemOut.println(&quot;=== Help on the SkyCave commands. ===&quot;);</span>
<span class="fc" id="L276">    systemOut.println(&quot;  Many commonly used commands are single-character&quot;);</span>
<span class="fc" id="L277">    systemOut.println(&quot;Commands:&quot;);</span>
<span class="fc" id="L278">    systemOut.println(&quot; n,s,e,w,d,u    :  MOVE north, south, etc;&quot;);</span>
<span class="fc" id="L279">    systemOut.println(&quot; q              :  QUIT sky cave;&quot;);</span>
<span class="fc" id="L280">    systemOut.println(&quot; h              :  HELP, print this help instructions;&quot;);</span>
<span class="fc" id="L281">    systemOut.println(&quot; l              :  LOOK, print long description of the room you are in;&quot;);</span>
<span class="fc" id="L282">    systemOut.println(&quot; p              :  POSITION, print your (x,y,z) position&quot;);</span>
<span class="fc" id="L283">    systemOut.println(&quot;Longer Commands:&quot;);</span>
<span class="fc" id="L284">    systemOut.println(&quot; who            :  WHO, print info on your avatar;&quot;);</span>
<span class="fc" id="L285">    systemOut.println(&quot; dig [d] [desc] :  DIG room in direction [d] with description [desc];&quot;);</span>
<span class="fc" id="L286">    systemOut.println(&quot; post [msg]     :  POST [msg] on this room's wall;&quot;);</span>
<span class="fc" id="L287">    systemOut.println(&quot; read           :  READ messages on this room's wall;&quot;);</span>
<span class="fc" id="L288">    systemOut.println(&quot; weather        :  WEATHER in the players region;&quot;);</span>
<span class="fc" id="L289">    systemOut.println(&quot; sys            :  SYStem and configuration information;&quot;);</span>

<span class="fc" id="L291">    systemOut.println(&quot; exec [cmd] [param]* :  EXEC [cmd] with 1 or more [param]s;&quot;);</span>
    
<span class="fc" id="L293">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201506030918</span></div></body></html>