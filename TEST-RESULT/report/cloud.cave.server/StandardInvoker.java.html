<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StandardInvoker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage of SkyCave</a> &gt; <a href="index.source.html" class="el_package">cloud.cave.server</a> &gt; <span class="el_source">StandardInvoker.java</span></div><h1>StandardInvoker.java</h1><pre class="source lang-java linenums">package cloud.cave.server;

import java.util.*;

import org.json.simple.*;
import org.slf4j.*;

import cloud.cave.domain.*;
import cloud.cave.ipc.*;

/** Standard implementation of the Invoker.
 * 
 * @author Henrik Baerbak Christensen, University of Aarhus
 *
 */
public class StandardInvoker implements Invoker {
  private Logger logger;
  private Dispatcher dispatcher;
  
  private Map&lt;String,Dispatcher&gt; mapKey2Dispatch;

  /** Create an invoker that dispatches requests
   * using default dispatching, that is the
   * set of methods known in the initial release of
   * SkyCave.
   * @param cave the cave that all requests manipulate
   */
<span class="fc" id="L28">  public StandardInvoker(Cave cave) {</span>
    // Create the map that maps from class prefix to
    // dispatcher for that particular class type,
    // see Reactor pattern and 'identifyDispather' method.
<span class="fc" id="L32">    mapKey2Dispatch = new HashMap&lt;String, Dispatcher&gt;();</span>
<span class="fc" id="L33">    mapKey2Dispatch.put(MarshalingKeys.CAVE_TYPE_PREFIX, new CaveDispatcher(cave));</span>
<span class="fc" id="L34">    mapKey2Dispatch.put(MarshalingKeys.PLAYER_TYPE_PREFIX, new PlayerDispatcher(cave));</span>
    
<span class="fc" id="L36">    logger = LoggerFactory.getLogger(StandardInvoker.class);</span>
<span class="fc" id="L37">  }</span>
  
  /** Create an invoker that dispatches requests
   * to the given cave using a given dispatcher.
   * @param cave the cave that all requests manipulate
   * @param mapTypePrefixToDispatchers a Map that
   * maps strings to dispatchers; the key string must
   * be one of the type prefixes, like &quot;player-&quot;, defined
   * in the MarshalingKeys.
   */
<span class="fc" id="L47">  public StandardInvoker(Cave cave, Map&lt;String,Dispatcher&gt; mapTypePrefixToDispatchers) {</span>
<span class="fc" id="L48">    mapKey2Dispatch = mapTypePrefixToDispatchers;</span>
<span class="fc" id="L49">    logger = LoggerFactory.getLogger(StandardInvoker.class);</span>
<span class="fc" id="L50">  }</span>
  
  
  @Override
  public JSONObject handleRequest(JSONObject request) {
<span class="fc" id="L55">    JSONObject reply = null;  </span>
 
    // Extract the common parameters from the request object and assign
    // them names that reflect their meaning
<span class="fc" id="L59">    String playerID = request.get(MarshalingKeys.PLAYER_ID_KEY).toString();</span>
<span class="fc" id="L60">    String sessionID = request.get(MarshalingKeys.PLAYER_SESSION_ID_KEY).toString(); </span>
<span class="fc" id="L61">    String methodKey = request.get(MarshalingKeys.METHOD_KEY).toString();</span>
<span class="fc" id="L62">    String parameter1 = &quot;&quot;;</span>
<span class="fc" id="L63">    Object parameter1AsObj = request.get(MarshalingKeys.PARAMETER_HEAD_KEY);</span>
<span class="fc bfc" id="L64" title="All 4 branches covered.">    if ( parameter1AsObj != null ) {</span>
<span class="fc" id="L65">      parameter1 = parameter1AsObj.toString();</span>
    }
<span class="fc" id="L67">    JSONArray parameterList = </span>
<span class="fc" id="L68">        (JSONArray) request.get(MarshalingKeys.PARAMETER_TAIL_KEY);</span>
 
    // Dispatch the event (POSA vol 4 Reactor code)
<span class="fc" id="L71">    dispatcher = identifyDispatcher(methodKey);</span>
    
    // We may get a null object back if the method key is ill formed
    // thus guard the dispatch call
<span class="fc bfc" id="L75" title="All 4 branches covered.">    if (dispatcher != null) {</span>
      // Next, do the dispatching - based upon the parameters, call
      // the proper method on the proper object
<span class="fc" id="L78">      reply = dispatcher.dispatch(methodKey, playerID, sessionID, parameter1,</span>
          parameterList);
    }    
    // UNHANDLED METHOD 
<span class="fc bfc" id="L82" title="All 4 branches covered.">    if (reply == null) {</span>
<span class="fc" id="L83">      reply = Marshaling.createInvalidReplyWithExplantion(StatusCode.SERVER_UNKNOWN_METHOD_FAILURE,</span>
          &quot;StandardInvoker.handleRequest: Unhandled request as the method key &quot;+methodKey +
<span class="fc" id="L85">          &quot; is unknown. Full request=&quot;+request.toString());</span>
<span class="fc" id="L86">      logger.warn(&quot;handleRequest: Unhandled request as the method key &quot;+methodKey +</span>
<span class="fc" id="L87">          &quot; is unknown. Full request=&quot;+request.toString());</span>
    }

<span class="fc" id="L90">    return reply;</span>
  }

  /** Identify the dispatcher appropriate for the given method.
   * Corresponds to the identify_handler(event) in Reactor
   * pattern.
   * &lt;p&gt;
   * Presently relies on mangled method names, i.e. that
   * a method on the player starts with 'play' and a method
   * on cave starts with 'cave'. 
   * 
   * @param methodKey key of the method, see MarshalingKeys
   * @return the appropriate dispatcher for the class containing
   * that particular method or null if the method key is ill-formed
   */
  private Dispatcher identifyDispatcher(String methodKey) {
<span class="fc" id="L106">    Dispatcher dsp = dispatcher;</span>
<span class="fc" id="L107">    int firstDash = methodKey.indexOf(&quot;-&quot;);</span>
<span class="fc" id="L108">    String key = methodKey.substring(0, firstDash+1);</span>
<span class="fc" id="L109">    dsp = mapKey2Dispatch.get(key);</span>
<span class="fc" id="L110">    return dsp;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201506030918</span></div></body></html>