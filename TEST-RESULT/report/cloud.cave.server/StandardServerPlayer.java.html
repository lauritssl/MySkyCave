<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StandardServerPlayer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=2;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Coverage of SkyCave</a> &gt; <a href="index.source.html" class="el_package">cloud.cave.server</a> &gt; <span class="el_source">StandardServerPlayer.java</span></div><h1>StandardServerPlayer.java</h1><pre class="source lang-java linenums">package cloud.cave.server;

import java.util.*;

import org.json.simple.JSONObject;

import cloud.cave.domain.*;
import cloud.cave.ipc.*;
import cloud.cave.server.common.*;
import cloud.cave.service.*;

/**
 * Standard implementation of Player on the server side. Interacts with
 * underlying storage for mutator methods, and some of the more complex accessor
 * methods.
 * 
 * @author Henrik Baerbak Christensen, Aarhus University.
 * 
 */
public class StandardServerPlayer implements Player {

  /** The classpath used to search for Command objects
   */
  public static final String EXTENSION_CLASSPATH = &quot;cloud.cave.extension&quot;;

  private CaveStorage storage;
  private String ID;
  private String sessionId;

  // These attributes of the player are essentially
  // caching of the 'true' information which is stored in
  // the underlying cave storage.
  private String name;
  private String groupName;
  private Region region;
  private RoomRecord currentRoom;
  private String position;

  private WeatherService weatherService;

  /**
   * Never call this constructor directly, use cave.login() instead!
   * Create a player instance bound to the given delegates for
   * session caching, persistence, etc.
   * 
   * @param playerID
   *          the player's id
   * @param storage
   *          the storage service connector for the cave and players
   * @param weatherService
   *          the weather service connector
   * @param sessionCache the cache of player sessions to use
   */
  StandardServerPlayer(String playerID, CaveStorage storage,
      WeatherService weatherService, PlayerSessionCache sessionCache) {
<span class="fc" id="L56">    super();</span>
<span class="fc" id="L57">    this.ID = playerID;</span>
<span class="fc" id="L58">    this.storage = storage;</span>
<span class="fc" id="L59">    this.weatherService = weatherService;</span>
    
<span class="fc" id="L61">    refreshFromStorage();</span>
<span class="fc" id="L62">  }</span>

  @Override
  public String getName() {
<span class="fc" id="L66">    return name;</span>
  }

  public String getGroupName() {
<span class="fc" id="L70">    return groupName;</span>
  }

  @Override
  public String getID() {
<span class="fc" id="L75">    return ID;</span>
  }

  @Override
  public String getShortRoomDescription() {
<span class="fc" id="L80">    return currentRoom.description;</span>
  }

  @Override
  public String getLongRoomDescription() {
<span class="fc" id="L85">    String allOfIt = getShortRoomDescription()+&quot;\nThere are exits in directions:\n&quot;;</span>
<span class="fc bfc" id="L86" title="All 4 branches covered.">    for ( Direction dir : getExitSet()) {</span>
<span class="fc" id="L87">      allOfIt += &quot;  &quot;+dir+&quot; &quot;;</span>
<span class="fc" id="L88">    }</span>
<span class="fc" id="L89">    allOfIt += &quot;\nYou see other players:\n&quot;;</span>
<span class="fc" id="L90">    List&lt;String&gt; playerNameList = getPlayersHere();</span>
<span class="fc" id="L91">    int count = 0;</span>
<span class="fc bfc" id="L92" title="All 4 branches covered.">    for ( String p : playerNameList ) {</span>
<span class="fc" id="L93">      allOfIt += &quot;  [&quot;+count+&quot;] &quot; + p;</span>
<span class="fc" id="L94">      count ++;</span>
<span class="fc" id="L95">    }</span>
<span class="fc" id="L96">    return allOfIt;</span>
  }

  @Override
  public List&lt;Direction&gt; getExitSet() {
<span class="fc" id="L101">    return storage.getSetOfExitsFromRoom(position);</span>
  }

  @Override
  public Region getRegion() {
<span class="fc" id="L106">    return region;</span>
  }

  @Override
  public String getPosition() {
<span class="fc" id="L111">    return storage.getPlayerByID(getID()).getPositionAsString();</span>
  }

  @Override
  public List&lt;String&gt; getPlayersHere() {
<span class="fc" id="L116">    List&lt;PlayerRecord&gt; playerList = storage.computeListOfPlayersAt(getPosition());</span>
<span class="fc" id="L117">    List&lt;String&gt; playerNameList = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L118" title="All 4 branches covered.">    for (PlayerRecord record: playerList) {</span>
<span class="fc" id="L119">      playerNameList.add(record.getPlayerName());</span>
<span class="fc" id="L120">    }</span>
<span class="fc" id="L121">    return playerNameList;</span>
  }
  
  @Override
  public String getSessionID() {
<span class="fc" id="L126">    return sessionId;</span>
  }

  @Override
  public void addMessage(String message) {
    // TODO Empty stub, to be implemented by students
<span class="fc" id="L132">  }</span>

  @Override
  public List&lt;String&gt; getMessageList() {
    // TODO Empty stub, to be implemented by students
<span class="fc" id="L137">    List&lt;String&gt; contents = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L138">    contents.add(&quot;NOT IMPLEMENTED YET&quot;);</span>
<span class="fc" id="L139">    return contents;</span>
  }

  @Override
  public String getWeather() {
<span class="fc" id="L144">    JSONObject weatherAsJson = </span>
<span class="fc" id="L145">        weatherService.requestWeather(getGroupName(), getID(), getRegion());</span>
<span class="fc" id="L146">    String weather = convertToFormattedString(weatherAsJson);</span>
<span class="fc" id="L147">    return weather;</span>
  }
  
  /**
   * Convert a JSON object that represents weather in the format of the cave
   * weather service into the string representation defined for the cave UI.
   * 
   * @param currentObservation
   *          weather information formatted as JSON
   * @return formatted string describing the weather
   */
  private String convertToFormattedString(JSONObject currentObservation) {

<span class="fc" id="L160">    String result = null;</span>
<span class="fc bfc" id="L161" title="All 4 branches covered.">    if (currentObservation.get(&quot;authenticated&quot;).equals(&quot;true&quot;)) {</span>
<span class="fc" id="L162">      String temperature = currentObservation.get(&quot;temperature&quot;).toString();</span>
<span class="fc" id="L163">      double tempDouble = Double.parseDouble(temperature);</span>

<span class="fc" id="L165">      String feelslike = currentObservation.get(&quot;feelslike&quot;).toString();</span>
<span class="fc" id="L166">      double feelDouble = Double.parseDouble(feelslike);</span>

<span class="fc" id="L168">      String winddir = currentObservation.get(&quot;winddirection&quot;).toString();</span>

<span class="fc" id="L170">      String windspeed = currentObservation.get(&quot;windspeed&quot;).toString();</span>
<span class="fc" id="L171">      double windSpDouble = Double.parseDouble(windspeed);</span>

<span class="fc" id="L173">      String weather = currentObservation.get(&quot;weather&quot;).toString();</span>

<span class="fc" id="L175">      String time = currentObservation.get(&quot;time&quot;).toString();</span>

<span class="fc" id="L177">      result = String</span>
<span class="fc" id="L178">          .format(</span>
              Locale.US,
              &quot;The weather in %s is %s, temperature %.1fC (feelslike %.1fC). Wind: %.1f m/s, direction %s. This report is dated: %s.&quot;,
<span class="fc" id="L181">              getRegion().toString(), weather, tempDouble, feelDouble,</span>
<span class="fc" id="L182">              windSpDouble, winddir, time);</span>
<span class="fc" id="L183">    } else {</span>
<span class="fc" id="L184">      result = &quot;The weather service failed with message: &quot;</span>
<span class="fc" id="L185">          + currentObservation.get(&quot;errorMessage&quot;);</span>
    }
<span class="fc" id="L187">    return result;</span>
  }

  @Override
  public boolean move(Direction direction) {
    // Calculate the offsets in the given direction
<span class="fc" id="L193">    Point3 p = Point3.parseString(position);</span>
<span class="fc" id="L194">    p.translate(direction);</span>
    // convert to the new position in string format
<span class="fc" id="L196">    String newPosition = p.getPositionString();</span>
    // get the room in that direction
<span class="fc" id="L198">    RoomRecord newRoom = storage.getRoom(newPosition);</span>
    // if it is null, then there is no room in that direction
<span class="fc bfc" id="L200" title="All 4 branches covered.">    if ( newRoom == null ) { return false; }</span>
    // otherwise update internal state
<span class="fc" id="L202">    position = p.getPositionString();</span>
<span class="fc" id="L203">    currentRoom = newRoom;</span>
    
    // and update this player's position in the storage
<span class="fc" id="L206">    PlayerRecord pRecord = storage.getPlayerByID(this.getID());</span>
<span class="fc" id="L207">    pRecord.setPositionAsString(position);</span>
<span class="fc" id="L208">    storage.updatePlayerRecord(pRecord);</span>
<span class="fc" id="L209">    return true;</span>
  }

  @Override
  public boolean digRoom(Direction direction, String description) {
    // Calculate the offsets in the given direction
<span class="fc" id="L215">    Point3 p = Point3.parseString(position);</span>
<span class="fc" id="L216">    p.translate( direction);</span>
<span class="fc" id="L217">    RoomRecord room = new RoomRecord(description);</span>
<span class="fc" id="L218">    return storage.addRoom(p.getPositionString(), room);</span>
  }

  @Override
  public JSONObject execute(String commandName, String... parameters) {
    // Compute the qualified path of the command class that shall be loaded
<span class="fc" id="L224">    String qualifiedClassName = EXTENSION_CLASSPATH + &quot;.&quot; + commandName;</span>

    // Load it
<span class="fc" id="L227">    Class&lt;?&gt; theClass = null;</span>
    try {
<span class="fc" id="L229">      theClass = Class.forName(qualifiedClassName);</span>
<span class="fc" id="L230">    } catch (ClassNotFoundException e) {</span>
<span class="fc" id="L231">      return Marshaling.createInvalidReplyWithExplantion(StatusCode.SERVER_FAILED_TO_LOAD_COMMAND,</span>
          &quot;Player.execute failed to load Command class: &quot;+commandName);
<span class="fc" id="L233">    }</span>
    
    // Next, instantiate the command object
<span class="fc" id="L236">    Command command = null; </span>
    try {
<span class="fc" id="L238">      command = (Command) theClass.newInstance();</span>
<span class="nc" id="L239">    } catch (InstantiationException | IllegalAccessException e) {</span>
<span class="nc" id="L240">      return Marshaling.createInvalidReplyWithExplantion(StatusCode.SERVER_FAILED_TO_INSTANTIATE_COMMAND,</span>
          &quot;Player.execute failed to instantiate Command object: &quot;+commandName);
<span class="fc" id="L242">    }</span>
    
    // Initialize the command object
<span class="fc" id="L245">    command.setPlayerID(getID());</span>
<span class="fc" id="L246">    command.setStorageService(storage);</span>
    
    // And execute the command...
<span class="fc" id="L249">    JSONObject reply = command.execute(parameters);</span>
    
    // as the command may update any aspect of the player' data
    // and as we cache it here locally, invalidate the caching
<span class="fc" id="L253">    refreshFromStorage();</span>
    
<span class="fc" id="L255">    return reply;</span>
  }

  private void refreshFromStorage() {
<span class="fc" id="L259">    PlayerRecord pr = storage.getPlayerByID(ID);</span>
<span class="fc" id="L260">    name = pr.getPlayerName();</span>
<span class="fc" id="L261">    groupName = pr.getGroupName();</span>
<span class="fc" id="L262">    position = pr.getPositionAsString();</span>
<span class="fc" id="L263">    region = pr.getRegion();</span>
<span class="fc" id="L264">    sessionId = pr.getSessionId(); </span>

<span class="fc" id="L266">    currentRoom = storage.getRoom(position);</span>
<span class="fc" id="L267">  }</span>

  @Override
  public String toString() {
<span class="fc" id="L271">    return &quot;StandardServerPlayer [storage=&quot; + storage + &quot;, name=&quot; + name</span>
        + &quot;, ID=&quot; + ID + &quot;, region=&quot; + region + &quot;, currentRoom=&quot; + currentRoom
        + &quot;, position=&quot; + position + &quot;, sessionId=&quot; + sessionId + &quot;]&quot;;
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201506030918</span></div></body></html>